<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrazione Hotel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
        .form-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: 600; font-size: 14px; }
        input[type="text"], input[type="date"], input[type="number"], select { padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 14px; transition: border-color 0.3s; }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: #576c7e; }
        input[type="text"]:disabled, input[type="number"]:disabled, select:disabled { background-color: #f5f5f5; cursor: not-allowed; }
        button { padding: 14px; background: #576c7e; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(87, 108, 126, 0.4); }
        button:active { transform: translateY(0); }
        .export-btn { background: #999; }
        .export-btn:hover { box-shadow: 0 5px 20px rgba(153, 153, 153, 0.4); }
        .button-wrapper { grid-column: 1 / -1; display: flex; gap: 10px; margin-top: 10px; }
        .button-wrapper button { flex: 1; }
        .message { grid-column: 1 / -1; padding: 15px; border-radius: 5px; margin-top: 20px; text-align: center; font-weight: 600; display: none; }
        .message.success { background-color: #d4edda; color: #155724; display: block; }
        .message.error { background-color: #f8d7da; color: #721c24; display: block; }
        #riepilogoPrenotazione { grid-column: 1 / -1; padding: 15px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        #riepilogoDettagli { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee; font-size: 14px; }
        #riepilogoTotale { font-size: 18px; font-weight: 700; text-align: right; color: #576c7e; }
        .page-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 18px; }
        .page-header-left h1 { font-size: 34px; color: #22303b; margin-bottom: 8px; font-weight: 800; }
        .page-subtitle { color: #6b7280; font-size: 16px; margin-top: 2px; }
        .page-header-right { font-size: 12px; color: #9ca3af; text-align: right; }
    </style>
</head>
<body>
    <header class="page-header">
        <div class="page-header-left">
            <h1>Prenota</h1>
            <p class="page-subtitle">Registra e gestisci le prenotazioni in tempo reale.</p>
        </div>
        <div class="page-header-right"></div>
    </header>

    <form id="hotelForm">
        <div class="form-wrapper">
            <div class="form-group">
                <label for="cliente">Cliente *</label>
                <input type="text" id="cliente" name="cliente" required>
            </div>
            
            <div class="form-group">
                <label for="telegram">Telegram *</label>
                <input type="text" id="telegram" name="telegram" required>
            </div>
            
            <div class="form-group">
                <label for="dataNascita">Data di Nascita *</label>
                <input type="date" id="dataNascita" name="dataNascita" required>
            </div>
            
            <div class="form-group">
                <label for="numeroCamera">Numero Camera *</label>
                <select id="numeroCamera" name="numeroCamera" required>
                    <option value="">-- Seleziona --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="checkIn">Check-in *</label>
                <input type="date" id="checkIn" name="checkIn" required>
            </div>
            
            <div class="form-group">
                <label for="totaleGiorni">Totale Giorni *</label>
                <input type="number" id="totaleGiorni" name="totaleGiorni" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="checkOut">Check-out</label>
                <input type="date" id="checkOut" name="checkOut" disabled>
            </div>
            
            <div class="form-group">
                <label for="polizza">Polizza *</label>
                <select id="polizza" name="polizza" required>
                    <option value="">-- Seleziona --</option>
                    <option value="//">//</option>
                    <option value="Corallo">Corallo</option>
                    <option value="Smeraldo">Smeraldo</option>
                    <option value="Oceano">Oceano</option>
                    <option value="Poseidon">Poseidon</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="giorniPoseidon">Giorni Poseidon *</label>
                <input type="number" id="giorniPoseidon" name="giorniPoseidon" min="0" value="0" disabled>
            </div>
            
            <div class="form-group">
                <label for="dipendente">Dipendente *</label>
                <select id="dipendente" name="dipendente" required>
                    <option value="">-- Seleziona --</option>
                </select>
            </div>

            <div id="riepilogoPrenotazione">
                <div id="riepilogoDettagli">
                    <span>Numero Camera: <strong id="cameraRiassunto">--</strong></span>
                    <span>Prezzo Camera: <strong id="prezzoCameraRiassunto">€ 0,00</strong></span>
                    <span>Prezzo Polizza: <strong id="prezzoPolizzaRiassunto">€ 0,00</strong></span>
                </div>
                <div id="riepilogoTotale">
                    Totale: <span id="totaleRiassunto">€ 0,00</span>
                </div>
            </div>
            
            <div class="button-wrapper">
                <button type="submit" class="submit-btn">Registra</button>
                <button type="button" id="exportBtn" class="export-btn">Esporta</button>
            </div>

            <div id="message" class="message"></div>
        </div>
    </form>

    <script>
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbxt8FmpXFHPGeXiXN3VgzH_NqNpAg4-ajjZSPI5ZmryQdM0bqFmqm9meZqbUjq9byRn/exec';
        const sheetId = '1ygcJnTd6p9yX7x8XP3bZvMdNvYbaxLRBP_QBcaRNc50';
        const PRENOTAZIONI_GID = '1372958227';
        const DISDETTE_GID = '692494043';

        const cameraData = {
            'Essential': [1, 2, 3, 100, 101, 102, 200, 201, 202, 300, 301, 302, 400, 401, 402, 500, 501, 502, 600, 601, 602, 700, 701, 702, 800, 801, 802],
            'Classic': [4, 6, 8, 9, 103, 104, 105, 106, 107, 108, 109, 110, 203, 205, 207, 209, 303, 304, 305, 306, 307, 308, 309, 310, 403, 405, 407, 409, 503, 504, 505, 506, 507, 508, 509, 510, 603, 605, 607, 609, 703, 704, 705, 706, 707, 708, 709, 710, 803, 805, 807, 809],
            'Suite+': [5, 204, 404, 604],
            'Suite': [7, 206, 406, 606],
            'Deluxe': [900, 903, 904],
            'Divinity': [901, 902]
        };

        const prezziCamere = {
            'Essential': 85.00,
            'Classic': 110.00,
            'Suite': 170.00,
            'Suite+': 200.00,
            'Deluxe': 235.00,
            'Divinity': 250.00
        };

        const prezziPolizzeBase = {
            '//': 0.00,
            'Corallo': 125.00,
            'Smeraldo': 650.00,
            'Oceano': 1275.00,
            'Poseidon': 1275.00
        };

        const cameraTipo = {};
        Object.keys(cameraData).forEach(tipo => {
            cameraData[tipo].forEach(camera => {
                cameraTipo[camera] = tipo;
            });
        });

        const form = document.getElementById('hotelForm');
        const numeroCamera = document.getElementById('numeroCamera');
        const checkIn = document.getElementById('checkIn');
        const totaleGiorni = document.getElementById('totaleGiorni');
        const checkOut = document.getElementById('checkOut');
        const polizza = document.getElementById('polizza');
        const giorniPoseidon = document.getElementById('giorniPoseidon');
        const messageDiv = document.getElementById('message');
        const dipendenteSelect = document.getElementById('dipendente');
        
        const prezzoCameraRiassunto = document.getElementById('prezzoCameraRiassunto');
        const prezzoPolizzaRiassunto = document.getElementById('prezzoPolizzaRiassunto');
        const totaleRiassunto = document.getElementById('totaleRiassunto');

        const formatter = new Intl.NumberFormat('it-IT', {
            style: 'currency',
            currency: 'EUR',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        const allCameras = Object.keys(cameraTipo).sort((a, b) => parseInt(a) - parseInt(b));
        allCameras.forEach(camera => {
            const option = document.createElement('option');
            option.value = camera;
            option.textContent = camera + ' (' + cameraTipo[camera] + ')';
            numeroCamera.appendChild(option);
        });

        async function loadDipendenti() {
            const gidDipendenti = '663672816';
            const csvUrlDipendenti = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gidDipendenti}`;
            
            try {
                const response = await fetch(csvUrlDipendenti);
                const csvText = await response.text();
                const rows = csvText.split('\n').filter(row => row.trim() !== '');

                const headerCols = rows[0].split(',').map(h => h.trim().toLowerCase());
                let idxName = headerCols.findIndex(h => h.includes('nome') || h.includes('name') || h.includes('nomin'));
                let idxMail = headerCols.findIndex(h => h.includes('mail') || h.includes('e-mail'));
                if (idxName === -1) idxName = 0;
                if (idxMail === -1) idxMail = 1;
                
                try {
                    const userEmailResponse = await fetch(`${webAppUrl}?app=getUserEmail`);
                    const userEmailData = await userEmailResponse.json();
                    if (userEmailData && userEmailData.email) {
                        window.currentUserEmail = userEmailData.email;
                    }
                } catch (error) {
                    console.error("Impossibile ottenere l'email dell'utente:", error);
                }

                for (let i = 1; i < rows.length; i++) {
                    const cols = rows[i].split(',');
                    const nomeDipendente = (cols[idxName] || cols[0] || '').trim();

                    if (nomeDipendente) {
                        const option = document.createElement('option');
                        option.value = nomeDipendente;
                        option.textContent = nomeDipendente;
                        dipendenteSelect.appendChild(option);
                    }
                }
                
            } catch (error) {
                console.error('Errore nel caricamento dei dipendenti:', error);
            }
        }
        
        setTimeout(loadDipendenti, 100);

        function updateSummary() {
            const selectedCamera = numeroCamera.value;
            const tipoCamera = selectedCamera ? cameraTipo[selectedCamera] : null;
            const selectedPolizza = polizza.value;
            const giorniExtraPoseidon = parseInt(giorniPoseidon.value) || 0;

            let prezzoCamera = tipoCamera ? prezziCamere[tipoCamera] : 0.00;
            let prezzoPolizza = prezziPolizzeBase[selectedPolizza] || 0.00;

            if (selectedPolizza === 'Poseidon') {
                let giorniAggiuntivi = Math.max(0, giorniExtraPoseidon - 1);
                let incrementoGiornaliero = 1275.00 * 0.02;
                let costoAggiuntivo = Math.floor(incrementoGiornaliero * giorniAggiuntivi);
                prezzoPolizza = prezziPolizzeBase['Poseidon'] + costoAggiuntivo;
            }

            const nights = parseInt(totaleGiorni.value) || 0;
            let roomBaseTotal = prezzoCamera * nights;

            let surcharge = 0;
            if (nights > 30) {
                surcharge = Math.floor(roomBaseTotal * 0.35 * 100) / 100;
            }

            const roomTotal = Math.floor((roomBaseTotal + surcharge) * 100) / 100;
            const totale = Math.floor((roomTotal + prezzoPolizza) * 100) / 100;

            document.getElementById('cameraRiassunto').textContent = selectedCamera || "--";
            prezzoCameraRiassunto.textContent = formatter.format(roomTotal);
            prezzoPolizzaRiassunto.textContent = formatter.format(prezzoPolizza);
            totaleRiassunto.textContent = formatter.format(totale);
        }
        
        polizza.addEventListener('change', function() {
            if (this.value === 'Poseidon') {
                giorniPoseidon.disabled = false;
                if (parseInt(giorniPoseidon.value) < 1) {
                    giorniPoseidon.value = '1';
                }
            } else {
                giorniPoseidon.disabled = true;
                giorniPoseidon.value = '0';
            }
            updateSummary();
        });

        giorniPoseidon.addEventListener('input', function() {
            if (polizza.value === 'Poseidon' && (parseInt(this.value) < 1 || this.value === '')) {
                this.value = '1';
            }
            updateSummary();
        });

        numeroCamera.addEventListener('change', updateSummary);
        
        function calculateCheckOut() {
            const checkInDate = new Date(checkIn.value);
            const giorni = parseInt(totaleGiorni.value) || 0;
            
            if (checkIn.value && giorni > 0) {
                const checkOutDate = new Date(checkInDate);
                checkOutDate.setDate(checkOutDate.getDate() + giorni);
                
                const year = checkOutDate.getFullYear();
                const month = String(checkOutDate.getMonth() + 1).padStart(2, '0');
                const day = String(checkOutDate.getDate()).padStart(2, '0');
                
                checkOut.value = `${year}-${month}-${day}`;
            } else {
                checkOut.value = '';
            }
        }

        checkIn.addEventListener('change', calculateCheckOut);
        totaleGiorni.addEventListener('change', calculateCheckOut);
        totaleGiorni.addEventListener('input', updateSummary);
        
        form.addEventListener('reset', () => {
            setTimeout(() => {
                checkOut.value = '';
                giorniPoseidon.disabled = true;
                giorniPoseidon.value = '0';
                updateSummary();
            }, 50);
        });

        async function loadOccupiedCameras() {
            const options = numeroCamera.querySelectorAll('option');
            options.forEach(option => {
                option.disabled = false;
                option.textContent = option.textContent.replace(' [OCCUPATA]', '');
            });

            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Carica prenotazioni
                const prenotazioniUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${PRENOTAZIONI_GID}`;
                const prenotazioniResp = await fetch(prenotazioniUrl);
                const prenotazioniText = await prenotazioniResp.text();
                const prenotazioniRows = prenotazioniText.split('\n');
                
                const camereConPrenotazioneAttiva = new Set();
                
                for (let i = 1; i < prenotazioniRows.length; i++) {
                    if (!prenotazioniRows[i].trim()) continue;
                    
                    const cols = prenotazioniRows[i].split(',');
                    const numeroCameraStr = cols[0]?.trim();
                    const checkOutStr = cols[6]?.trim();
                    
                    if (numeroCameraStr && checkOutStr) {
                        const checkOutDate = new Date(checkOutStr);
                        checkOutDate.setHours(0, 0, 0, 0);
                        
                        if (!isNaN(checkOutDate) && checkOutDate >= today) {
                            camereConPrenotazioneAttiva.add(numeroCameraStr);
                        }
                    }
                }

                // Carica disdette
                const disdetteUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${DISDETTE_GID}`;
                const disdetteResp = await fetch(disdetteUrl);
                const disdetteText = await disdetteResp.text();
                const disdetteRows = disdetteText.split('\n');

                const camereDisdette = new Map();

                for (let i = disdetteRows.length - 1; i > 0; i--) {
                    if (!disdetteRows[i].trim()) continue;

                    const cols = disdetteRows[i].split(',');
                    const numeroCamera = cols[0]?.trim();
                    const disdetta = cols[4]?.trim().toUpperCase() === 'TRUE';

                    if (numeroCamera && !camereDisdette.has(numeroCamera)) {
                        camereDisdette.set(numeroCamera, disdetta);
                    }
                }

                // Determina camere occupate
                const occupiedCameras = new Set();

                camereConPrenotazioneAttiva.forEach(camera => {
                    const hasDisdetta = camereDisdette.get(camera) === true;
                    
                    if (!hasDisdetta) {
                        occupiedCameras.add(camera);
                    }
                });
                
                options.forEach(option => {
                    if (option.value && occupiedCameras.has(option.value)) {
                        option.disabled = true;
                        if (!option.textContent.includes(' [OCCUPATA]')) {
                            option.textContent += ' [OCCUPATA]';
                        }
                    }
                });
            } catch (error) {
                console.error('Errore nel caricamento camere occupate:', error);
            }
            updateSummary();
        }

        setTimeout(loadOccupiedCameras, 500);

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!document.getElementById('numeroCamera').value ||
                !document.getElementById('polizza').value ||
                !document.getElementById('dipendente').value) {
                messageDiv.textContent = '⚠ Seleziona tutte le opzioni richieste!';
                messageDiv.className = 'message error';
                setTimeout(() => { messageDiv.className = 'message'; }, 3000);
                return;
            }
            
            const dataToSend = {
                numeroCamera: numeroCamera.value,
                cliente: document.getElementById('cliente').value,
                telegram: document.getElementById('telegram').value,
                dataNascita: document.getElementById('dataNascita').value,
                totaleGiorni: totaleGiorni.value,
                checkIn: checkIn.value,
                checkOut: checkOut.value,
                polizza: polizza.value,
                dipendente: dipendenteSelect.value,
                elaboratoDa: window.currentUserEmail || dipendenteSelect.value,
                giorniPoseidon: giorniPoseidon.value,
                prezzoCamera: prezzoCameraRiassunto.textContent,
                prezzoPolizza: prezzoPolizzaRiassunto.textContent,
                totalePrenotazione: totaleRiassunto.textContent
            };

            const urlEncodedData = new URLSearchParams(dataToSend);

            try {
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                    body: new URLSearchParams(Object.assign({ app: 'prenotazioni', append: 'true' }, Object.fromEntries(urlEncodedData)))
                });

                messageDiv.textContent = '✓ Registrazione salvata con successo!';
                messageDiv.className = 'message success';
                
                form.reset();
                
                setTimeout(loadDipendenti, 500);
                setTimeout(loadOccupiedCameras, 1000);
                
                setTimeout(() => { messageDiv.className = 'message'; }, 4000);
            } catch (error) {
                messageDiv.textContent = '❌ Errore di rete. Controlla la connessione.';
                messageDiv.className = 'message error';
                console.error("Errore di rete/fetch:", error);
                
                setTimeout(() => { messageDiv.className = 'message'; }, 4000);
            }
        });
    </script>
</body>
</html>
